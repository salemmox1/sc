name: RDP Full Scanner (FreeRDP)
on: 
  workflow_dispatch: # تشغيل يدوي من تبويب Actions

jobs:
  capture-screens:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y freerdp2-x11 xvfb scrot

      - name: Setup Virtual Display
        run: |
          # إنشاء شاشة وهمية لمعالجة النوافذ الرسومية
          Xvfb :99 -screen 0 1280x1024x24 &
          echo "DISPLAY=:99" >> $GITHUB_ENV

      - name: Run xfreerdp Scan
        run: |
          export DISPLAY=:99
          
          # قراءة البورت الافتراضي من الملف أو استخدام 3389
          DEFAULT_PORT=$(grep "port=" nonla.txt | cut -d'=' -f2 || echo "3389")
          
          # معالجة كل IP في الملف
          grep -v "port=" nonla.txt | while read -r line || [ -n "$line" ]; do
            [[ -z "$line" ]] && continue
            
            if [[ $line == *":"* ]]; then
                IP=$(echo $line | cut -d':' -f1)
                PORT=$(echo $line | cut -d':' -f2)
            else
                IP=$line
                PORT=$DEFAULT_PORT
            fi

            echo "[*] Connecting to $IP:$PORT..."
            
            # استخدام xfreerdp مع خيارات لزيادة التوافق:
            # /cert:ignore تخطي الشهادات
            # /sec:rdp إجبار استخدام البروتوكول القياسي (بدون NLA)
            # /v: العنوان
            timeout 30s xfreerdp /v:$IP /port:$PORT /cert:ignore /sec:rdp /size:1280x1024 /u:user /p:pass +auth-only &
            XFREE_PID=$!
            
            # انتظار تحميل الشاشة
            sleep 15
            
            # التقاط الصورة
            scrot "${IP}_logon.png"
            
            # إغلاق العملية الحالية
            kill $XFREE_PID || true
            sleep 2
          done

      - name: Upload Results
        uses: actions/upload-artifact@v4
        with:
          name: rdp-screenshots
          path: "*.png"
