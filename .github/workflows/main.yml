name: RDP Full Scanner (Custom Limit)
on: 
  workflow_dispatch:
    inputs:
      scan_limit:
        description: 'عدد الأجهزة التي ترغب في فحصها من القائمة'
        required: true
        default: '5'

jobs:
  capture-screens:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y freerdp2-x11 xvfb fluxbox scrot

      - name: Setup Virtual Display
        run: |
          # إنشاء شاشة وهمية
          Xvfb :99 -screen 0 1280x1024x24 &
          echo "DISPLAY=:99" >> $GITHUB_ENV

      - name: Run xfreerdp Scan
        run: |
          export DISPLAY=:99
          fluxbox & # تشغيل مدير النوافذ لضمان ظهور الإطار الرسومي
          sleep 3

          # استخراج البورت الافتراضي
          DEFAULT_PORT=$(grep "port=" nonla.txt | cut -d'=' -f2 || echo "3389")
          
          # استخراج العدد المطلوب من المدخلات
          LIMIT=${{ github.event.inputs.scan_limit }}
          echo "[*] Starting scan for the first $LIMIT targets..."

          # قراءة الأسطر بناءً على العدد المحدد
          grep -v "port=" nonla.txt | head -n "$LIMIT" | while read -r line || [ -n "$line" ]; do
            [[ -z "$line" ]] && continue
            
            if [[ $line == *":"* ]]; then
                IP=$(echo $line | cut -d':' -f1)
                PORT=$(echo $line | cut -d':' -f2)
            else
                IP=$line
                PORT=$DEFAULT_PORT
            fi

            echo "[*] Connecting to $IP:$PORT..."
            
            # تصحيح صياغة الأمر: تم تغيير /gfx:off و /audio-mode لضمان التوافق
            # تم إزالة +auth-only للسماح بظهور الشاشة
            timeout 40s xfreerdp /v:$IP:$PORT /cert:ignore /sec:any /size:1024x768 /u:admin /p:admin /network:auto -themes -wallpaper /audio-mode:2 &
            XFREE_PID=$!
            
            # انتظار تحميل الواجهة الرسومية
            sleep 25
            
            # التقاط الصورة
            scrot "${IP}_screen.png"
            
            # إنهاء العملية للانتقال للتالي
            kill $XFREE_PID || kill -9 $XFREE_PID || true
            sleep 2
          done

      - name: Upload Results
        uses: actions/upload-artifact@v4
        with:
          name: rdp-screenshots
          path: "*.png"
