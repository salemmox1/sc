name: RDP Full Scanner (Custom Limit)
on: 
  workflow_dispatch:
    inputs:
      scan_limit:
        description: 'عدد الأجهزة المراد فحصها (مثلاً: 5)'
        required: true
        default: '10'

jobs:
  capture-screens:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y freerdp2-x11 xvfb fluxbox scrot

      - name: Setup Virtual Display
        run: |
          Xvfb :99 -screen 0 1280x1024x24 &
          echo "DISPLAY=:99" >> $GITHUB_ENV

      - name: Run xfreerdp Scan
        run: |
          export DISPLAY=:99
          fluxbox &
          sleep 3

          DEFAULT_PORT=$(grep "port=" nonla.txt | cut -d'=' -f2 || echo "3389")
          
          # استخراج العدد المطلوب من المدخلات
          LIMIT=${{ github.event.inputs.scan_limit }}
          echo "[*] Starting scan for the first $LIMIT targets..."

          # استخدام head لتحديد عدد الأسطر المقروءة من الملف
          grep -v "port=" nonla.txt | head -n "$LIMIT" | while read -r line || [ -n "$line" ]; do
            [[ -z "$line" ]] && continue
            
            if [[ $line == *":"* ]]; then
                IP=$(echo $line | cut -d':' -f1)
                PORT=$(echo $line | cut -d':' -f2)
            else
                IP=$line
                PORT=$DEFAULT_PORT
            fi

            echo "[*] Connecting to $IP:$PORT..."
            
            # تشغيل xfreerdp بدون +auth-only لضمان ظهور الجرافيك
            timeout 35s xfreerdp /v:$IP /port:$PORT /cert:ignore /sec:any /size:1024x768 /u:admin /p:admin /network:auto /gfx:off /audio-mode:2 &
            XFREE_PID=$!
            
            sleep 25
            scrot "${IP}_logon.png"
            
            kill $XFREE_PID || kill -9 $XFREE_PID || true
            sleep 2
          done

      - name: Upload Results
        uses: actions/upload-artifact@v4
        with:
          name: rdp-screenshots
          path: "*.png"
